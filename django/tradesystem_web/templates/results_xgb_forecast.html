{% extends 'base_layout.html' %}
{% load static %}

{% block title %}XGBoost予測結果一覧{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'results_xgb_forecast.css' %}?v=20260220-2">
{% endblock %}

{% block content %}
    <h1>XGBoost予測結果一覧</h1>
    <div class="filter-bar">
        <form method="get">
            <label for="market">市場・商品区分</label>
            <select id="market" name="market">
                <option value="">全て</option>
                {% for market in markets %}
                <option value="{{ market }}" {% if market == selected_market %}selected{% endif %}>{{ market }}</option>
                {% endfor %}
            </select>
            <button type="submit">絞り込み</button>
            {% if selected_market %}
            <a class="button subtle" href="{% url 'results_xgb_forecast' %}">クリア</a>
            {% endif %}
        </form>
    </div>
    <div class="meta">
        予測日: {% if trade_date %}{{ trade_date|date:"Y-m-d" }}{% else %}-{% endif %}
        / 学習終了日: {% if trained_end_date %}{{ trained_end_date|date:"Y-m-d" }}{% else %}-{% endif %}
        / model: {% if model_version %}{{ model_version }}{% else %}-{% endif %}
        / 件数: {{ page_obj.paginator.count }} ({{ page_obj.number }} / {{ page_obj.paginator.num_pages }}ページ)
    </div>

    <table>
        <thead>
            <tr>
                <th>コード</th>
                <th>銘柄名</th>
                <th>市場</th>
                <th>予測基準日<br>{% if trade_date %}{{ trade_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>予測日<br>{% if header_h1_date %}{{ header_h1_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>予測日<br>{% if header_h2_date %}{{ header_h2_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>予測日<br>{% if header_h3_date %}{{ header_h3_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>予測日<br>{% if header_h4_date %}{{ header_h4_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>予測日<br>{% if header_h5_date %}{{ header_h5_date|date:"Y-m-d" }}{% else %}yyyy-mm-dd{% endif %}</th>
                <th>推測値<br>(%)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in result_rows %}
            <tr>
                <td>{{ item.code }}</td>
                <td><a href="{% url 'stock_xgb_forecast_chart' item.code %}">{{ item.name }}</a></td>
                <td>{{ item.market }}</td>
                <td>{% if item.base_close is not None %}{{ item.base_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if item.h1_close is not None %}{{ item.h1_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if item.h2_close is not None %}{{ item.h2_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if item.h3_close is not None %}{{ item.h3_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if item.h4_close is not None %}{{ item.h4_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if item.h5_close is not None %}{{ item.h5_close|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>
                    {% if item.h5_pct is not None %}
                        {% if item.h5_pct > 0 %}
                            <span class="pct-positive">{{ item.h5_pct }}%</span>
                        {% elif item.h5_pct < 0 %}
                            <span class="pct-negative">{{ item.h5_pct }}%</span>
                        {% else %}
                            <span>{{ item.h5_pct }}%</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10">XGBoost予測データがありません。</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        {% if page_obj.has_previous %}
            <a class="button" href="?page={{ page_obj.previous_page_number }}{% if selected_market %}&market={{ selected_market }}{% endif %}">前ページ</a>
        {% else %}
            <span class="button disabled">前ページ</span>
        {% endif %}
        {% if page_obj.has_next %}
            <a class="button" href="?page={{ page_obj.next_page_number }}{% if selected_market %}&market={{ selected_market }}{% endif %}">次ページ</a>
        {% else %}
            <span class="button disabled">次ページ</span>
        {% endif %}
    </div>
{% endblock %}

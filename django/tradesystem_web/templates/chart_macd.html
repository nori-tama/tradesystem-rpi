{% extends 'base_layout.html' %}

{% block title %}MACD分析グラフ{% endblock %}

{% block content %}
    <h1>MACD分析グラフ</h1>
    <table class="chart-meta">
        <thead>
            <tr>
                <th>コード</th>
                <th>銘柄名</th>
                <th>市場・商品区分</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ listing.code }}</td>
                <td>{{ listing.name|default:"-" }}</td>
                <td>{{ listing.market|default:"-" }}</td>
            </tr>
        </tbody>
    </table>
    <div class="meta">対象期間: 最新100日 / MACD期間: ({{ window_short }}, {{ window_long }}, {{ window_signal }})</div>

    {% if price_chart_labels or chart_labels %}
    <div id="macdChart" class="chart-panel"></div>
    {% else %}
    <div class="meta">株価またはMACDデータがありません。</div>
    {% endif %}

{% endblock %}

{% block extra_js %}
    {{ price_chart_labels|json_script:"price-chart-labels" }}
    {{ open_values|json_script:"price-chart-open" }}
    {{ high_values|json_script:"price-chart-high" }}
    {{ low_values|json_script:"price-chart-low" }}
    {{ close_values|json_script:"price-chart-close" }}
    {{ monday_tick_labels|json_script:"price-chart-monday-ticks" }}
    {{ non_business_day_labels|json_script:"price-chart-non-business-days" }}
    {{ missing_plot_day_labels|json_script:"price-chart-missing-plot-days" }}

    {{ chart_labels|json_script:"macd-chart-labels" }}
    {{ macd_values|json_script:"macd-chart-values" }}
    {{ signal_values|json_script:"signal-chart-values" }}
    {{ histogram_values|json_script:"histogram-chart-values" }}

    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script>
        const rootStyle = getComputedStyle(document.documentElement);
        const blue700 = rootStyle.getPropertyValue('--blue-700').trim();
        const blue500 = rootStyle.getPropertyValue('--blue-500').trim();
        const borderColor = rootStyle.getPropertyValue('--border').trim();
        const riseRed = '#d32f2f';

        const priceLabels = JSON.parse(document.getElementById('price-chart-labels').textContent);
        const macdLabels = JSON.parse(document.getElementById('macd-chart-labels').textContent);
        if (priceLabels.length > 0 || macdLabels.length > 0) {
            const openValues = JSON.parse(document.getElementById('price-chart-open').textContent);
            const highValues = JSON.parse(document.getElementById('price-chart-high').textContent);
            const lowValues = JSON.parse(document.getElementById('price-chart-low').textContent);
            const closeValues = JSON.parse(document.getElementById('price-chart-close').textContent);
            const mondayTickLabels = JSON.parse(document.getElementById('price-chart-monday-ticks').textContent);
            const nonBusinessDays = JSON.parse(document.getElementById('price-chart-non-business-days').textContent);
            const missingPlotDays = JSON.parse(document.getElementById('price-chart-missing-plot-days').textContent);
            const macdValues = JSON.parse(document.getElementById('macd-chart-values').textContent);
            const signalValues = JSON.parse(document.getElementById('signal-chart-values').textContent);
            const histogramValues = JSON.parse(document.getElementById('histogram-chart-values').textContent);
            const chartPanel = document.getElementById('macdChart');
            const chartHeight = chartPanel ? chartPanel.clientHeight : 620;

            const traces = [];

            if (priceLabels.length > 0) {
                traces.push({
                    type: 'candlestick',
                    x: priceLabels,
                    open: openValues,
                    high: highValues,
                    low: lowValues,
                    close: closeValues,
                    name: 'ローソク足',
                    increasing: {
                        line: { color: riseRed, width: 1 },
                        fillcolor: 'rgba(211, 47, 47, 0.45)',
                    },
                    decreasing: {
                        line: { color: blue700, width: 1 },
                        fillcolor: 'rgba(47, 111, 178, 0.45)',
                    },
                    whiskerwidth: 0.3,
                    opacity: 1,
                    yaxis: 'y',
                });
            }

            if (macdLabels.length > 0) {
                traces.push(
                    {
                        type: 'bar',
                        x: macdLabels,
                        y: histogramValues,
                        yaxis: 'y2',
                        name: 'Histogram',
                        marker: { color: 'rgba(142, 36, 170, 0.35)' },
                    },
                    {
                        type: 'scatter',
                        mode: 'lines',
                        x: macdLabels,
                        y: macdValues,
                        yaxis: 'y2',
                        name: 'MACD',
                        line: { color: '#ffb300', width: 2 },
                    },
                    {
                        type: 'scatter',
                        mode: 'lines',
                        x: macdLabels,
                        y: signalValues,
                        yaxis: 'y2',
                        name: 'Signal',
                        line: { color: '#8e24aa', width: 2 },
                    },
                );
            }

            const layout = {
                height: chartHeight,
                margin: { l: 55, r: 65, t: 25, b: 90 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    type: 'date',
                    tickmode: 'array',
                    tickvals: mondayTickLabels,
                    ticktext: mondayTickLabels,
                    tickformat: '%Y-%m-%d',
                    tickangle: 90,
                    tickfont: { size: 11 },
                    showgrid: true,
                    gridcolor: borderColor,
                    gridwidth: 1.5,
                    automargin: true,
                    rangebreaks: [
                        { values: nonBusinessDays },
                        { values: missingPlotDays },
                    ],
                    rangeslider: { visible: false },
                },
                yaxis: {
                    title: '株価',
                    showgrid: true,
                    gridcolor: '#a0a0a0',
                    gridwidth: 1,
                    griddash: 'dot',
                    fixedrange: false,
                },
                yaxis2: {
                    title: 'MACD',
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false,
                    fixedrange: false,
                },
                legend: {
                    orientation: 'h',
                    bgcolor: '#ffffff',
                    x: 1,
                    y: 1,
                    xanchor: 'right',
                    yanchor: 'top',
                },
            };

            Plotly.newPlot('macdChart', traces, layout, {
                responsive: true,
                displaylogo: false,
            });
        }
    </script>
{% endblock %}
